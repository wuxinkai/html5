<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>选择城市</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/city.css">
    <script type="text/javascript" src="../js/bscroll.min.js"></script>
    <script type="text/javascript" src="../js/city.js"></script>
    <script type="text/javascript" src="../js/zepto.min.js"></script>
</head>
<body>
<!--头-->
<div class="public-header">
    <i class="ion-chevron-left"></i>
    <span class="titles">地区切换</span>
</div>

<!--内容-->
<div class="locations">
    <div class="line"></div>
  <div class="white">
      <i title="定位图标"></i>
      <b>北京</b>
      <span>当前定位城市</span>
  </div>
</div>
<div class="city">
    <div class="city-wrapper city-wrapper-hook">
        <div class="scroller-hook">
            <div class="cities cities-hook"></div>
        </div>
        <div class="shortcut shortcut-hook" ></div>
    </div>
</div>
<script>
    var cityWrapper = document.querySelector('.city-wrapper-hook');
    var cityScroller = document.querySelector('.scroller-hook');
    var cities = document.querySelector('.cities-hook');
    var shortcut = document.querySelector('.shortcut-hook');
    var scroll;
    var shortcutList = [];
    var anchorMap = {};
    function initCities() {
        var y = 0;
        var titleHeight = 32;
        var itemHeight = 120;
        var lists = '';
        var en = '<ul>';
        cityData.forEach(function (group,index) {
            var name = group.name;
            lists += '<div class="title" >'+name+'</div>';
            lists += '<ul class="num'+index+' ">';
            group.cities.forEach(function(g) {
                lists += '<li class="item" data-name="'+ g.name +'" data-id="'+ g.cityid +'"><span class="border-1px name">'+ g.name +'</span></li>';
            });
            lists += '</ul>';
            var name = group.name.substr(0, 1);
            en += '<li data-anchor="'+name+'" class="item">'+name+'</li>';
            var len = group.cities.length;
            anchorMap[name] = y;
            y -= titleHeight + len * itemHeight;
        });
        en += '</ul>';

        cities.innerHTML = lists;
        shortcut.innerHTML = en;
//        shortcut.style.top = (cityWrapper.clientHeight - shortcut.clientHeight) / 3 + 'px';
        shortcut.style.top = 0 + 'px';
        var windowHeight=$(window).height()-120;
        var LiHeight=windowHeight/27;
        $(".shortcut-hook ul li").css('height',LiHeight+'px')
        scroll = new window.BScroll(cityWrapper, {
            probeType: 3
        });
        // scroll.on('scroll', function (pos) {
        //   console.log(Math.round(pos.y));
        // });
        scroll.scrollTo(0, 0);
    }
    function bindEvent() {
        var touch = {};
        var firstTouch;
        shortcut.addEventListener('touchstart', function (e) {
            var anchor = e.target.getAttribute('data-anchor');
            firstTouch = e.touches[0];
            touch.y1 = firstTouch.pageY;
            touch.anchor = anchor;
            scrollTo(anchor);
        });
        shortcut.addEventListener('touchmove', function (e) {
            firstTouch = e.touches[0];
            touch.y2 = firstTouch.pageY;
            var anchorHeight = 16;
            var delta = (touch.y2 - touch.y1) / anchorHeight | 0;
            var anchor = shortcutList[shortcutList.indexOf(touch.anchor) + delta];
            scrollTo(anchor);
            e.preventDefault();
            e.stopPropagation();
        });
        function scrollTo(anchor) {
            var maxScrollY = cityWrapper.clientHeight - cityScroller.clientHeight;
            var y = Math.min(0, Math.max(maxScrollY, anchorMap[anchor]));
            if (typeof y !== 'undefined') {
                scroll.scrollTo(0, y);
            }
        }
    }
    initCities();
    bindEvent();
    $('.cities-hook ul li').bind("touchend",function(){
//        alert(  $(this).text())
    });
</script>
</body>
</html>